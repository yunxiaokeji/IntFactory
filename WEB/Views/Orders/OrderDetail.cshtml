@{
    ViewBag.Title = "订单详情页";
    var model = (IntFactoryEntity.OrderEntity)ViewBag.Model;
}
@section css{
    <link href="/modules/css/opportunitys.css" rel="stylesheet" />
    <link href="/modules/plug/umeditor/themes/default/css/umeditor.min.css" rel="stylesheet" />
}
@section scripts{
    <script src="/modules/plug/laydate/laydate.js"></script>
    <script type="text/javascript">
        seajs.use(["scripts/orders/detail"], function (obj) {
            obj.init('@(model.OrderID)','@(model.Status)','@Html.ToJSONString(model)');
        });
    </script>
}
<div class="header-box">
    <span class="header-title left">订单详情页</span>
    <a class="ico-back right" href="javascript:if(history.length>1){ history.go(-1);} else{}">返回 </a>
</div>
<div class="content-body mTop20">
    <div class="content-title">
        <div class="left titlename">订单编号：@(model.OrderCode)</div>
        @if (model.IsSelf)
        { 
            <div id="updateOrderInfo" class="left ico-edit mLeft50 @(ExpandClass.IsLimits(HttpContext.Current, "102019026"))"></div>
            if (model.Status == 0)
            {
                <div class="btn right @(ExpandClass.IsLimits(HttpContext.Current, "102019005"))" id="btnreturn" >退回委托</div>
                <div class="btnccc right @(ExpandClass.IsLimits(HttpContext.Current, "102019003"))" id="btndelete" >删除</div>
                <div class="btn mRight10 right @(ExpandClass.IsLimits(HttpContext.Current, "102019007"))" id="btnchangeclient" >订单委托</div>
            }
            else if (model.OrderStatus == 1)
            {
                 <div class="btnccc right @(ExpandClass.IsLimits(HttpContext.Current, "102019027"))" id="btnOverOrder" >终止订单</div>
            }
        }
       
    </div>
    <div class="order-imgs-div left">
        <div class="order-imgs">
            <img id="orderImage" src="@(model.OrderImage)" data-self="@(model.IsSelf ? 1 : 0)" />
        </div>
        <ul class="order-imgs-list" >

        </ul>
    </div>

    <ul class="left order-info">
        <li>
            <span class="column-title">负责人：</span> <label class="left" id="lblOwner">@(model.Owner != null ? model.Owner.Name : "--")</label>
            @if (model.IsSelf)
            {
                <span title="更换负责人" class="ico-change left mTop5 mLeft10 @(ExpandClass.IsLimits(HttpContext.Current, "102019004"))" data-userid="@(model.OwnerID)" data-id="@(model.OrderID)" id="changeOwner"></span>
            }
        </li>
        <li>
            <span class="column-title">客户名称：</span> 
            @if (!string.IsNullOrEmpty(model.CustomerID))
            {
                <a href="/Customer/Detail/@(model.CustomerID)" class="left">@(model.Customer.Name)</a> 
            }
            else if (model.IsSelf)
            {
                <div id="createOrderCustomer" class="btn left mTop3 @(ExpandClass.IsLimits(HttpContext.Current, "101019001"))">创建客户</div>
            }

            @if (model.IsSelf && model.OrderStatus == 0)
            {
                <span title="更换客户" class="ico-change left mTop5 mLeft10 @(ExpandClass.IsLimits(HttpContext.Current, "101019008"))" data-customerid="@(model.CustomerID)" data-id="@(model.OrderID)" id="changeCustomer"></span>
            }
        </li>
        <li class="@(ExpandClass.IsLimits(HttpContext.Current, "101019008"))">
            <span class="column-title">联系人：</span>
            <label>@(model.PersonName)</label>
        </li>
         <li class="@(ExpandClass.IsLimits(HttpContext.Current, "101019008"))">
            <span class="column-title">联系方式：</span>
            <label>@(model.MobileTele)</label>
        </li>  
        
         <li>
            <span class="column-title">期望价格：</span>
            <label>@(model.PlanPrice)</label>
        </li>
        <li class="@(ExpandClass.IsLimits(HttpContext.Current, "102019013"))">
            <span class="column-title">材料成本：</span>
            <label>@(model.Price.ToString("f2"))</label>
        </li>
        <li class="@(ExpandClass.IsLimits(HttpContext.Current, "102019014"))">
            <span class="column-title">加工成本：</span>
            <label id="lblCostMoney">@(model.CostPrice.ToString("f2"))</label>
        </li>
        <li class="@(ExpandClass.IsLimits(HttpContext.Current, "102019021"))">
            <span class="column-title">利润比例(%)：</span>
            <label class="left" id="profitPrice">@((model.ProfitPrice * 100).ToString("f2"))</label>
             @if (model.IsSelf && model.OrderStatus == 1)
             { 
                <div id="updateProfitPrice" class="left ico-edit mLeft20 mTop5"></div>
             }
        </li>
        <li class="@(ExpandClass.IsLimits(HttpContext.Current, "102019015"))">
            <span class="column-title">最终报价：</span>
            <label>@(model.FinalPrice.ToString("f2"))</label>
        </li>
        <li class="@(ExpandClass.IsLimits(HttpContext.Current, "102019017"))">
            <span class="column-title">付款金额：</span>
            <label id="infoPayMoney">@(model.PayMoney.ToString("f2"))</label>
        </li>
        <li>
            <span class="column-title">交货日期：</span>
            <label>@(model.PlanTime.ToString("yyyy-MM-dd"))</label>
        </li>
        <li class="@(ExpandClass.IsLimits(HttpContext.Current, "101019008"))">
            <span class="column-title">收货地区：</span>
            <label>@(model.City != null ? (model.City.Province + " " + model.City.City + " " + model.City.Counties) : "")</label>
        </li>
        <li class="@(ExpandClass.IsLimits(HttpContext.Current, "101019008"))">
            <span class="column-title">详细地址：</span>
            <label>@(model.Address)</label>
        </li>
     </ul>

    <ul class="right status-items">
        <li data-status="0">
            <span class="status-time mRight5">@(model.CreateTime.ToString("yyyy-MM-dd"))</span>
            <span class="status-bg"></span>
            <span class="mLeft5">需求单</span>
        </li>
        <li data-status="1"><span class="status-time mRight5">&nbsp;</span><span class="status-line"></span></li>
        <li data-status="1">
            <span class="status-time status-time-text mRight5">&nbsp;</span>
            <span class="status-bg"></span>
            <span class="mLeft5">打样中</span>
        </li>
        <li data-status="2"><span class="status-time mRight5">&nbsp;</span><span class="status-line"></span></li>
        <li data-status="2">
            <span class="status-time status-time-text mRight5">&nbsp;</span>
            <span class="status-bg"></span>
            <span class="mLeft5">合价中</span>
        </li>
        <li data-status="3"><span class="status-time mRight5">&nbsp;</span><span class="status-line"></span></li>
        <li data-status="3">
            <span class="status-time status-time-text mRight5">&nbsp;</span>
            <span class="status-bg"></span>
            <span class="mLeft5">封样封价</span>
        </li>
    </ul>

    <div class="clear"></div>
    <ul style="width:90%;" class="content-info mTop20">
        <li class="hide">
            <span class="column-title">加工数量：</span>
            <label id="planQuantity">@(model.PlanQuantity)</label>
        </li>
       
        <li  class="hide">
            <span class="column-title">总金额：</span>
            <label id="totalMoney">@(model.TotalMoney.ToString("f2"))</label>
        </li>
        <li style="width:100%;">
            <span class="column-title">详细需求：</span> 
            <label>@(model.Remark.Trim())</label>
        </li>
    </ul>

    <div class="clear"></div>

    <div class="process-stages mTop30">
        <div class="process-info">
            <div class="left info">订单流程：@(model.OrderProcess.ProcessName)</div>
            @if (model.IsSelf && model.OrderStatus == 0)
            {
                <span title="更换流程" class="ico-change left mLeft10 @(ExpandClass.IsLimits(HttpContext.Current, "102019006"))" data-processid="@(model.ProcessID)" data-id="@(model.OrderID)" id="changeProcess"></span>
            }
            <div class="left info mLeft20">负责人：@(model.OrderProcess.Owner.Name)</div>
            @if (model.IsSelf)
            {
                if (string.IsNullOrEmpty(model.CategoryID))
                {
                     <div class="btn right mLeft20 @(ExpandClass.IsLimits(HttpContext.Current, "102019019"))" id="changeOrderCategory">绑定品类</div>
                }
                else if (model.OrderStatus <= 2)
                {
                     <div class="btn right mLeft20 @(ExpandClass.IsLimits(HttpContext.Current, "102019002"))" id="changeOrderStatus"></div>
                }

                if (model.OrderStatus == 1)
                {
                    <div class="btn right mLeft20 @(ExpandClass.IsLimits(HttpContext.Current, "102019024"))" id="btnSendDYOrder">订单发货</div>
                
                    <div class="btn right mLeft20 @(ExpandClass.IsLimits(HttpContext.Current, "102019014"))" id="addOtherCost">添加加工成本</div>
                }


            }
        </div>
        <div class="clear"></div>
        <ul class="stage-items mTop20 @(ExpandClass.IsLimits(HttpContext.Current, "102019022"))">
            @if (model.Status > 0)
            {
                foreach (var stage in model.Tasts)
                { 
                    <li data-stageid="@(stage.StageID)" data-self="@(model.IsSelf ? 1 : 0)" data-orderid="@(model.OrderID)" data-taskid="@(stage.TaskID)" data-mark="@(stage.Mark)" class="@(stage.FinishStatus == 0 ? "normal" : stage.FinishStatus == 1 ? "ing" : "over") task-item">
                        <span class="name">@(stage.Title)</span>
                        <span class="status-bg right">
                            <span class="status-color"></span>
                        </span>
                        <span class="status right">@(stage.FinishStatus == 0 ? "未开始" : stage.FinishStatus == 1 ? "进行中" : "已完成")</span>
                    </li>
                }
            }
            else
            {
                foreach (var stage in model.OrderProcess.OrderStages)
                { 
                    <li data-id="@(stage.StageID)" class="normal">
                        <span class="name">@(stage.StageName)</span>
                        <span class="status-bg right">
                            <span class="status-color"></span>
                        </span>
                        <span class="status right">未开始</span>
                    </li>
                }
            }
        </ul>
    </div>

    <div class="tab-nav mTop30">
        <ul class="tab-nav-ul left">
            <li data-id="navEngraving" class="hover" data-mark="2">制版详情</li>
            <li class="@(ExpandClass.IsLimits(HttpContext.Current, "102019013"))" data-id="navProducts" data-mark="1">材料成本</li>
            <li class="@(ExpandClass.IsLimits(HttpContext.Current, "102019014"))" data-id="navCosts">加工成本</li>
            <li class="@(ExpandClass.IsLimits(HttpContext.Current, "102019024"))" data-id="navSendDoc">发货记录</li>
            <li data-id="navPays" class="navPays @(ExpandClass.IsLimits(HttpContext.Current, "102019017"))">付款记录</li>
            <li class="@(ExpandClass.IsLimits(HttpContext.Current, "102019028"))" data-id="navDHOrder">大货记录</li>
            <li data-id="navLog">日志</li>
        </ul>
        @if (model.IsSelf)
        {
            <div id="addPay" class="btn right @(ExpandClass.IsLimits(HttpContext.Current, "104010201"))">收款登记</div>
        }
    </div>

    <div id="navProducts" class="nav-partdiv hide">
        <table class="table-list mTop20">
            <tr class="tr-header">
                <td class="tLeft">样图</td>
                <td class="tLeft">材料名称</td>
                <td class="tLeft">编码</td>
                <td class="tLeft">规格</td>
                <td class="width80">单位</td>
                <td class="tLeft">单价</td>
                <td class="">消耗量</td>
                <td class="">损耗量</td>
                <td class="tRight">小计</td>
            </tr>
            @foreach (var detail in model.Details)
            { 
                <tr class="item cart-item" data-autoid="@(detail.AutoID)" data-id="@(detail.ProductDetailID)" >
                    <td class="width80">
                        <a href="/Products/ChooseDetail?pid=@(detail.ProductID)&did=@(detail.ProductDetailID)" target="_blank">
                            <img onerror="$(this).attr('src','/modules/images/img-noimg.png')" src="@(string.IsNullOrEmpty(detail.ImgS) ? detail.ProductImage : detail.ImgS)" />
                        </a>
                    </td>
                    <td><a href="/Products/ChooseDetail?pid=@(detail.ProductID)&did=@(detail.ProductDetailID)" target="_blank">@(detail.ProductName)</a></td>
                    <td>@(string.IsNullOrEmpty(detail.DetailsCode) ? detail.ProductCode : detail.DetailsCode)</td>
                    <td>@(detail.Remark)</td>
                    <td class="center">@(detail.UnitName)</td>
                    <td class="tr-price"><label class="price">@(detail.Price.ToString("f2"))</label></td>
                    <td class="center tr-quantity"><label class="quantity">@(detail.Quantity.ToString("f2"))</label></td>
                    <td class="center tr-loss"><label class="loss">@(detail.Loss.ToString("f2"))</label></td>
                    <td class="tRight amount">@((detail.TotalMoney).ToString("f2"))</td>
                </tr>
            }
            <tr class="amount-item">
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="tRight">成本合计：</td>
                <td class="tRight"><label id="amount"></label></td>
            </tr>
        </table>
    </div>

    <table id="navCosts" class="table-list mTop20 nav-partdiv hide" data-quantity="1">
        <tr class="tr-header">
            <td class="tLeft">描述</td>
            <td class="">金额</td>
            <td class="">添加日期</td>
            <td class="width80">删除</td>
        </tr>
    </table>

    <table id="navSendDoc" class="nav-partdiv table-list mTop20 hide">
        <tr class="tr-header">
            <td class="tLeft">单号</td>
            <td class="">总金额</td>
            <td class="width200">快递单号</td>
            <td class="width200">快递公司</td>
            <td class="width150">发货人</td>
            <td class="width200">发货时间</td>
        </tr>
    </table>

    <div class="nav-partdiv  mTop10" id="navEngraving">
        <div id="navEngravingInfo"></div>
        <div class="mTop20 talk-title">制版工艺</div>
        <div class="edui-container mTop20">
            <div class="edui-editor-body">
                <div class="description  edui-body-container" id="navEngravingRemark">

                 </div>
            </div>
        </div>
    </div>

    <table id="navPays" class="nav-partdiv table-list mTop20 hide">
        <tr class="tr-header">
            <td class="width150 tLeft">收款日期</td>
            <td class="">类型</td>
            <td class="">金额</td>
            <td class="width100">支付方式</td>
            <td class="tLeft">备注</td>
            <td class="width150">登记人</td>
            <td class="width200 tRight">登记时间</td>
        </tr>
    </table>

    <div class="nav-partdiv hide mTop20" id="navDHOrder">
        <table class="table-list">
            <tr class="tr-header">
                <td class="width30 tLeft"></td>
                <td class="width150 tLeft">订单编号</td>
                <td class="">状态</td>
                <td class="">价格</td>
                <td class="">数量</td>
                <td class="">金额</td>
                <td class="width100">交货日期</td>
                <td class="width150">负责人</td>
                <td class="width200 tRight">下单时间</td>
            </tr>
        </table>
        <div id="pagerOrders" class="mTop10">

        </div>
    </div>
    @*日志*@
    <div class="nav-partdiv hide" id="navLog">
        <div class="log-body" id="orderLog">

        </div>
        <div id="pagerLogs" class="mTop10">

        </div>
    </div>
</div>
<div class="enlarge-image-bgbox hide">
    <div class="ico-close close-enlarge-image"></div> 
</div>
<div class="enlarge-image-box hide">
    <div class="left-enlarge-image"></div>
    <div class="right-enlarge-image"></div>
    <img id="enlargeImage" src="" />
</div>
